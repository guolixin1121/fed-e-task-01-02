# JS性能优化

## 内存管理
申请内存 --> 使用内存 --> 释放内存      
JS的内存由V8引擎自动管理，不可直接通过API去操作内存  
JS 

## 常见GC算法

### 引用计数算法
引用计数器：记录可达对象的引用数，当引用关系发生改变时需修改计数器的值
某个对象的引用计数为0时，立即触发回收

**优缺点**
* 优点
  发现垃圾时立即回收；   
  最大限度减少程序暂停
* 缺点
  无法回收循环引用的变量
  时间开销大 - 需要不断维护引用计数的变化

### 标记清除算法
将垃圾回收分为：标记、清除，两个阶段   
1. 遍历所有对象标记活动对象
2. 遍历所有对象清除没有标记的对象

**优缺点**
* 优点
  能回收循环引用的变量      
* 缺点
  直接对内存进行回收，可能会造成空间的碎片化

### 标记整理算法
对标记清除的增强，也是分为标记和清除两个阶段
1. 遍历所有对象标记活动对象
2. 先整理活动对象到连续的内存存储，然后清除其余内存

在V8中配合标记清除使用

## V8及其GC
V8是一款主流JS执行引擎   
采用即时编译，所以效率高   
内存有上限：64位为1.5G，32位为800M（V8为浏览器使用，V8的垃圾回收机制，使得这样的内存限制足够使用）

NOTE： JS对象分为原始类型变量和对象，原始类型的变量由程序语言自身控制，GC的回收主要是针对堆区的对象的回收。   
  
V8采用分代回收思想，分为新生代、老生代，不同代采用不同的回收机制。   
新生代对象：存活时间较短，如局部变量   
老生代对象：存活时间较长，如全局对象，闭包里变量   

内存分为不同区域分别存储新生代和老生代对象

### 新生代回收
32M或16M空间用户存储新生代对象   
回收采用：复制算法+标记整理   
1. 将新生代内存区分为二个等大小的空间：FROM（使用的空间），TO（空闲的空间）
2. 标记整理后将活动对象copy到TO
3. From与To交换空间完成内存释放

**NOTE**：copy时可能会将新生代挪移到老生代，如果：
1. 一轮GC后还存活的新生代
2. To空间的使用率超过25%

### 老生代回收
1.4G或700M用于存储老生代对象   
回收采用：标记清除+标记整理+增量标记
1. 主要采用标记清除完成垃圾回收
2. 新生代晋升老生代，且老生代存储不够时，采用标记整理进行空间优化
3. 采用增量标记进行效率的优化
   将整段垃圾回收拆分成多个小段，可以使JS执行和GC交替执行，以提升整体效率   
   直接可达对象先回收，再查找子节点的标记清除 

### 新生代 VS 老生代
新生代使用空间换时间（空间本身很小，此方法代价小）   
老生代不适合赋值算法：老生代空间大 + 对象多   


## 监控内存的几种方式
三种不同的内存问题：
1. 内存泄漏 ： 内存持续升高，需去查看消耗内存的代码
2. 内存膨胀 ：为了达到设备的最佳性能引发的性能问题 
3. 频繁内存回收：通过内存变化图分析 

监控方式：
1. 浏览器任务管理图
浏览器打开网页后，shift+esc可以调出浏览器的任务管理器。   
任务管理器的列说明：
   * 内存：原生内存，即界面上DOM节点占据的内存
   * javascript运行内存：js的堆，所有可达对象的使用内存
  
2. Timeline时序图
浏览器打开网页后，F12打开开发者工具->性能，捕获页面情况，查看js堆内存

3. 堆快照查找分离DOM
界面上不存在，但JS变量有引用的DOM节点，成为`分离DOM`   
浏览器打开网页后，F12打开开发者工具->内存，获取堆快照(Heap snapshot)，查看分离DOM

4. 判断是否存在频繁的内存回收
GC是应用程序会暂停   
如何定位：Timeline中频繁上升下降，或者任务管理器中内存数据频繁的增加减小

## 代码优化
### 如何测量JS性能
使用 https://jsperf.com 网站进行性能定量测试   

### 代码优化几点建议
1. 慎用全局变量
2. 缓存全局变量
3. 通过原型新增方法
4. 避开闭包的陷阱 - 可能存在内存泄露的风险
5. 避免使用属性访问方法
6. For循环优化
   减少循环次数；缓存数组长度；选择最优的循环方式（Array的foreach > for > for in）
7. DOM节点操作优化
   避免频繁操作DOM，可以批量修改后一次性修改DOM
8. 直接量替换Object
9. 小黄加速器